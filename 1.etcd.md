### On your local workstation (Linux)

#### Generate TLS certificates
```bash
# Download required binaries
# CA will be a separate machine - ubuntu server
# Install cfssl and cfssljson packages on CA server
{
  sudo apt update
  sudo apt install golang-cfssl

  cfssl version
}

#Create a Certificate Authority (CA)
#We then use this CA to create other TLS certificates
{

cat > ca-config.json <<EOF
{
    "signing": {
        "default": {
            "expiry": "8760h"
        },
        "profiles": {
            "etcd": {
                "expiry": "8760h",
                "usages": ["signing","key encipherment","server auth","client auth"]
            }
        }
    }
}
EOF

cat > ca-csr.json <<EOF
{
  "CN": "etcd cluster",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "IN",
      "L": "India",
      "O": "Kubernetes",
      "OU": "etcd-ca",
      "ST": "Rajasthan"
    }
  ]
}
EOF

cfssl gencert -initca ca-csr.json | cfssljson -bare ca

}

#This will generate these files:
# ca.pem
# ca-key.pem
# ca.csr

#Create TLS certificate for etcd nodes
{

export ETCD1_IP=192.168.29.61
export ETCD1_NAME="etcdone"

export ETCD2_IP=192.168.29.62
export ETCD2_NAME="etcdtwo"

export ETCD3_IP=192.168.29.63
export ETCD3_NAME="etcdthree"

cat > etcdone-csr.json <<EOF
{
  "CN": "etcdone",
  "hosts": [
    "localhost",
    "127.0.0.1",
    "${ETCD1_IP}",
    "${ETCD1_NAME}"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "IN",
      "L": "Jaipur",
      "O": "etcd",
      "OU": "etcd-cluster",
      "ST": "Rajasthan"
    }
  ]
}
EOF

cat > etcdtwo-csr.json <<EOF
{
  "CN": "etcdtwo",
  "hosts": [
    "localhost",
    "127.0.0.1",
    "${ETCD2_IP}",
    "${ETCD2_NAME}"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "IN",
      "L": "Jaipur",
      "O": "etcd",
      "OU": "etcd-cluster",
      "ST": "Rajasthan"
    }
  ]
}
EOF

cat > etcdthree-csr.json <<EOF
{
  "CN": "etcdthree",
  "hosts": [
    "localhost",
    "127.0.0.1",
    "${ETCD3_IP}",
    "${ETCD3_NAME}"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "IN",
      "L": "Jaipur",
      "O": "etcd",
      "OU": "etcd-cluster",
      "ST": "Rajasthan"
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=etcd \
  etcdone-csr.json | cfssljson -bare etcdone

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=etcd \
  etcdtwo-csr.json | cfssljson -bare etcdtwo

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=etcd \
  etcdthree-csr.json | cfssljson -bare etcdthree


#This will generate these files:
# etcdone.pem
# etcdone-key.pem
# etcdtwo.pem
# etcdtwo-key.pem
# etcdthree.pem
# etcdthree-key.pem

}
```
```bash
{

cat > ca-config-client.json <<EOF
{
  "signing": {
    "default": {
      "expiry": "8760h"
    },
    "profiles": {
      "etcd": {
        "expiry": "8760h",
        "usages": [
          "signing",
          "key encipherment",
          "client auth"
        ]
      }
    }
  }
}
EOF

cat > apiserver-etcd-client-csr.json <<EOF
{
  "CN": "kube-apiserver-etcd-client",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "IN",
      "L": "Jaipur",
      "O": "Kubernetes",
      "OU": "ControlPlane",
      "ST": "Rajasthan"
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config-client.json \
  -profile=etcd \
  apiserver-etcd-client-csr.json | cfssljson -bare apiserver-etcd-client

#THIS WILL CREATE:
# apiserver-etcd-client.pem
# apiserver-etcd-client-key
ls -l apiserver-etcd-client*

openssl x509 -in apiserver-etcd-client.pem -noout -text | grep -A2 "Extended Key Usage"
# Extended Key Usage:
#     TLS Web Client Authentication

}
```

#### Copy the certificates to etcd nodes
```bash
{
  apt install -y sshpass

  PASSWORD="root"
  NODES=(etcdone etcdtwo etcdthree)

  # Create PKI directory on all nodes
  for node in "${NODES[@]}"; do
    sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@"$node" "
      mkdir -p /etc/etcd/pki &&
      chown -R root:root /etc/etcd/pki &&
      chmod 700 /etc/etcd/pki
    "
  done

  # Copy certificates + set permissions
  for node in "${NODES[@]}"; do
    sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no \
      ca.pem \
      ${node}.pem \
      ${node}-key.pem \
      root@${node}:/etc/etcd/pki/

    sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@"$node" "
      chmod 600 /etc/etcd/pki/${node}-key.pem &&
      chmod 644 /etc/etcd/pki/${node}.pem &&
      chmod 644 /etc/etcd/pki/ca.pem
    "
  done
}
```

#### Copy certs to masterone node
```bash
{

  PASSWORD="root"

  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@masterone "mkdir -p /etc/kubernetes/pki/etcd/"

  sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no ca.pem \
    apiserver-etcd-client.pem \
    apiserver-etcd-client-key.pem \
    root@masterone:/etc/kubernetes/pki/etcd/

  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@masterone "chmod 644 /etc/kubernetes/pki/etcd/ca.pem"
  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@masterone "chmod 644 /etc/kubernetes/pki/etcd/apiserver-etcd-client.pem"
  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@masterone "chmod 600 /etc/kubernetes/pki/etcd/apiserver-etcd-client-key.pem"

}
```

### On all etcd nodes
Perform all commands logged in as root user or prefix each command with sudo as appropriate

#### INSTALL ETCD ON EACH NODE
```bash
#Download etcd & etcdctl binaries from Github
{
  ETCD_VER=v3.5.21
  wget -q --show-progress "https://github.com/etcd-io/etcd/releases/download/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz"
  tar -zxf etcd-${ETCD_VER}-linux-amd64.tar.gz
  mv etcd-${ETCD_VER}-linux-amd64/etcd* /usr/local/bin/
  rm -rf etcd*
  which etcdctl
}
```

#### CREATE ETCD SERVICE FILE(etcd-1)
```bash
{


export ETCD1_IP=192.168.29.61
export ETCD1_NAME="etcdone"

export ETCD2_IP=192.168.29.62
export ETCD2_NAME="etcdtwo"

export ETCD3_IP=192.168.29.63
export ETCD3_NAME="etcdthree"

export ETCD_NODE_NAME=$(hostname -s)
echo $ETCD_NODE_NAME

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcdone.pem \\
  --key-file=/etc/etcd/pki/etcdone-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcdone.pem \\
  --peer-key-file=/etc/etcd/pki/etcdone-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD1_NAME}:2380 \\
  --listen-peer-urls https://${ETCD1_IP}:2380 \\
  --listen-client-urls https://${ETCD1_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD1_NAME}:2379 \\
  --initial-cluster-token etcd-cluster \\
  --initial-cluster etcdone=https://${ETCD1_NAME}:2380,etcdtwo=https://${ETCD2_NAME}:2380,etcdthree=https://${ETCD3_NAME}:2380 \\
  --initial-cluster-state new 

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start etcd
systemctl enable etcd

}
```

#### CREATE ETCD SERVICE FILE(etcd-2)
```bash
{


export ETCD1_IP=192.168.29.61
export ETCD1_NAME="etcdone"

export ETCD2_IP=192.168.29.62
export ETCD2_NAME="etcdtwo"

export ETCD3_IP=192.168.29.63
export ETCD3_NAME="etcdthree"

export ETCD_NODE_NAME=$(hostname -s)

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcdtwo.pem \\
  --key-file=/etc/etcd/pki/etcdtwo-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcdtwo.pem \\
  --peer-key-file=/etc/etcd/pki/etcdtwo-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD2_NAME}:2380 \\
  --listen-peer-urls https://${ETCD2_IP}:2380 \\
  --listen-client-urls https://${ETCD2_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD2_NAME}:2379 \\
  --initial-cluster-token etcd-cluster \\
  --initial-cluster etcdone=https://${ETCD1_NAME}:2380,etcdtwo=https://${ETCD2_NAME}:2380,etcdthree=https://${ETCD3_NAME}:2380 \\
  --initial-cluster-state new

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now etcd

}
```

#### CREATE ETCD SERVICE FILE(etcd-3)
```bash
{

export ETCD1_IP=192.168.29.61
export ETCD1_NAME="etcdone"

export ETCD2_IP=192.168.29.62
export ETCD2_NAME="etcdtwo"

export ETCD3_IP=192.168.29.63
export ETCD3_NAME="etcdthree"

export ETCD_NODE_NAME=$(hostname -s)

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcdthree.pem \\
  --key-file=/etc/etcd/pki/etcdthree-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcdthree.pem \\
  --peer-key-file=/etc/etcd/pki/etcdthree-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD3_NAME}:2380 \\
  --listen-peer-urls https://${ETCD3_IP}:2380 \\
  --listen-client-urls https://${ETCD3_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD3_NAME}:2379 \\
  --initial-cluster-token etcd-cluster \\
  --initial-cluster etcdone=https://${ETCD1_NAME}:2380,etcdtwo=https://${ETCD2_NAME}:2380,etcdthree=https://${ETCD3_NAME}:2380 \\
  --initial-cluster-state new

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start etcd
systemctl enable etcd
}

```

#### Better to export these as environment variables and connect to the clutser instead of a specific node
```bash
#On All Nodes
export ENDPOINTS=https://etcdone:2379,https://etcdtwo:2379,https://etcdthree:2379
export ETCDCTL_CACERT=/etc/etcd/pki/ca.pem

#On etcdone
export ETCDCTL_CERT=/etc/etcd/pki/etcdone.pem
export ETCDCTL_KEY=/etc/etcd/pki/etcdone-key.pem
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS endpoint health --write-out=table

#On etcdtwo
export ETCDCTL_CERT=/etc/etcd/pki/etcdtwo.pem
export ETCDCTL_KEY=/etc/etcd/pki/etcdtwo-key.pem
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS endpoint health --write-out=table

#On etcdthree
export ETCDCTL_CERT=/etc/etcd/pki/etcdthree.pem
export ETCDCTL_KEY=/etc/etcd/pki/etcdthree-key.pem
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS endpoint health --write-out=table
```


