### On your local workstation (Linux)

#### Generate TLS certificates
```bash
# Download required binaries
# CA will be a separate machine - ubuntu server
# Install cfssl and cfssljson packages on CA server
{
  sudo apt update
  sudo apt install golang-cfssl

  cfssl version
}

#Create a Certificate Authority (CA)
#We then use this CA to create other TLS certificates
{

cat > ca-config.json <<EOF
{
    "signing": {
        "default": {
            "expiry": "8760h"
        },
        "profiles": {
            "etcd": {
                "expiry": "8760h",
                "usages": ["signing","key encipherment","server auth","client auth"]
            }
        }
    }
}
EOF

cat > ca-csr.json <<EOF
{
  "CN": "etcd cluster",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "IN",
      "L": "India",
      "O": "Kubernetes",
      "OU": "etcd-ca",
      "ST": "Rajasthan"
    }
  ]
}
EOF

cfssl gencert -initca ca-csr.json | cfssljson -bare ca

}

#This will generate these files:
# ca.pem
# ca-key.pem
# ca.csr

#Create TLS certificate for etcd nodes
{

  
export ETCD1_IP=192.168.29.61
export ETCD2_IP=192.168.29.62
export ETCD3_IP=192.168.29.63

cat > etcd-csr.json <<EOF
{
  "CN": "etcd",
  "hosts": [
    "localhost",
    "127.0.0.1",
    "${ETCD1_IP}",
    "${ETCD2_IP}",
    "${ETCD3_IP}"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "IN",
      "L": "India",
      "O": "Kubernetes",
      "OU": "etcd",
      "ST": "Rajasthan"
    }
  ]
}
EOF

cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | cfssljson -bare etcd

#This will generate these files:
# etcd.pem
# etcd-key.pem

}
```
```bash
cat > ca-config1.json <<EOF
{
  "signing": {
    "default": {
      "expiry": "8760h"
    },
    "profiles": {
      "etcd": {
        "expiry": "8760h",
        "usages": [
          "signing",
          "key encipherment",
          "client auth"
        ]
      }
    }
  }
}
EOF

cat > apiserver-etcd-client-csr.json <<EOF
{
  "CN": "kube-apiserver-etcd-client",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "IN",
      "L": "Jaipur",
      "O": "Kubernetes",
      "OU": "ControlPlane",
      "ST": "Rajasthan"
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config1.json \
  -profile=etcd \
  apiserver-etcd-client-csr.json | cfssljson -bare apiserver-etcd-client

ls -l apiserver-etcd-client*

openssl x509 -in apiserver-etcd-client.pem -noout -text | grep -A2 "Extended Key Usage"
# Extended Key Usage:
#     TLS Web Client Authentication

```

#### Copy the certificates to etcd nodes
```bash
declare -a NODES=(192.168.29.61 192.168.29.62 192.168.29.63)

for node in "${NODES[@]}"; do
  ssh root@"$node" "mkdir -p /etc/etcd/pki"

  scp \
    ca.pem \
    etcd.pem \
    etcd-key.pem \
    root@"$node":/etc/etcd/pki/
done
```

#### Copy certs to masterone node
```bash
ssh root@192.168.29.51 "mkdir -p /etc/kubernetes/pki/etcd/"

scp ca.pem \
   apiserver-etcd-client.pem \
   apiserver-etcd-client-key.pem \
  root@192.168.29.51:/etc/kubernetes/pki/etcd/

ssh root@192.168.29.51 "chmod 644 /etc/kubernetes/pki/etcd/ca.pem"
ssh root@192.168.29.51 "chmod 644 /etc/kubernetes/pki/etcd/apiserver-etcd-client.pem"
ssh root@192.168.29.51 "chmod 600 /etc/kubernetes/pki/etcd/apiserver-etcd-client-key.pem"
```

### On all etcd nodes
Perform all commands logged in as root user or prefix each command with sudo as appropriate

#### INSTALL ETCD ON EACH NODE
```bash
#Download etcd & etcdctl binaries from Github
{
  ETCD_VER=v3.5.21
  wget -q --show-progress "https://github.com/etcd-io/etcd/releases/download/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz"
  tar -zxf etcd-${ETCD_VER}-linux-amd64.tar.gz
  mv etcd-${ETCD_VER}-linux-amd64/etcd* /usr/local/bin/
  rm -rf etcd*
}
```

#### CREATE ETCD SERVICE FILE(etcd-1)
```bash
{

export ETCD1_IP=192.168.29.61
export ETCD2_IP=192.168.29.62
export ETCD3_IP=192.168.29.63

export ETCD_NODE_NAME=$(hostname -s)
echo $ETCD_NODE_NAME

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcd.pem \\
  --key-file=/etc/etcd/pki/etcd-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcd.pem \\
  --peer-key-file=/etc/etcd/pki/etcd-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD1_IP}:2380 \\
  --listen-peer-urls https://${ETCD1_IP}:2380 \\
  --listen-client-urls https://${ETCD1_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD1_IP}:2379 \\
  --initial-cluster-token etcd-cluster-1 \\
  --initial-cluster etcdone=https://${ETCD1_IP}:2380,etcdtwo=https://${ETCD2_IP}:2380,etcdthree=https://${ETCD3_IP}:2380 \\
  --initial-cluster-state new 

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start etcd
systemctl enable etcd

}
```

#### CREATE ETCD SERVICE FILE(etcd-2)
```bash
{

export ETCD1_IP=192.168.29.61
export ETCD2_IP=192.168.29.62
export ETCD3_IP=192.168.29.63

export ETCD_NODE_NAME=$(hostname -s)

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcd.pem \\
  --key-file=/etc/etcd/pki/etcd-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcd.pem \\
  --peer-key-file=/etc/etcd/pki/etcd-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD2_IP}:2380 \\
  --listen-peer-urls https://${ETCD2_IP}:2380 \\
  --listen-client-urls https://${ETCD2_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD2_IP}:2379 \\
  --initial-cluster-token etcd-cluster-1 \\
  --initial-cluster etcdone=https://${ETCD1_IP}:2380,etcdtwo=https://${ETCD2_IP}:2380,etcdthree=https://${ETCD3_IP}:2380 \\
  --initial-cluster-state new

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now etcd

}
```

#### CREATE ETCD SERVICE FILE(etcd-3)
```bash
{

export ETCD1_IP=192.168.29.61
export ETCD2_IP=192.168.29.62
export ETCD3_IP=192.168.29.63

export ETCD_NODE_NAME=$(hostname -s)

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcd.pem \\
  --key-file=/etc/etcd/pki/etcd-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcd.pem \\
  --peer-key-file=/etc/etcd/pki/etcd-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD3_IP}:2380 \\
  --listen-peer-urls https://${ETCD3_IP}:2380 \\
  --listen-client-urls https://${ETCD3_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD3_IP}:2379 \\
  --initial-cluster-token etcd-cluster-1 \\
  --initial-cluster etcdone=https://${ETCD1_IP}:2380,etcdtwo=https://${ETCD2_IP}:2380,etcdthree=https://${ETCD3_IP}:2380 \\
  --initial-cluster-state new

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start etcd
systemctl enable etcd

}
```

### DEMO

#### CHECK ENDPOINT STATUS (ALL NODES UP)
```bash
#HTTP
etcdctl --endpoints=http://192.168.29.61:2379 member list --write-out=table
etcdctl --endpoints=http://192.168.29.62:2379 endpoint status --write-out=table
etcdctl --endpoints=http://192.168.29.63:2379 endpoint status --write-out=table


#HTTPS
etcdctl --endpoints=https://192.168.29.61:2379 \
  --cacert= /etc/kubernetes/pki/etcd/ca.pem \
  --cert= /etc/kubernetes/pki/etcd/apiserver-etcd-client.pem \
  --key= /etc/kubernetes/pki/etcd/apiserver-etcd-client-key.pem  \
  member list --write-out=table

etcdctl --endpoints=https://192.168.29.62:2379 \
  --cacert=/etc/etcd/pki/ca.pem \
  --cert=/etc/etcd/pki/etcd.pem \
  --key=/etc/etcd/pki/etcd-key.pem \
  endpoint status --write-out=table

etcdctl --endpoints=https://192.168.29.63:2379 \
  --cacert=/etc/etcd/pki/ca.pem \
  --cert=/etc/etcd/pki/etcd.pem \
  --key=/etc/etcd/pki/etcd-key.pem \
  endpoint status --write-out=table

```

#### Better to export these as environment variables and connect to the clutser instead of a specific node
```bash
#HTTP
export ENDPOINTS=http://192.168.29.61:2379,http://192.168.29.62:2379,http://192.168.29.63:2379


#HTTPS
export ENDPOINTS=https://192.168.29.61:2379,https://192.168.29.62:2379,https://192.168.29.63:2379
export ETCDCTL_CACERT=/etc/etcd/pki/ca.pem
export ETCDCTL_CERT=/etc/etcd/pki/etcd.pem
export ETCDCTL_KEY=/etc/etcd/pki/etcd-key.pem
```

#### WRITE / READ / DELETE DATA (ALL NODES)
```bash
etcdctl --endpoints=$ENDPOINTS put name alok-srivastava
etcdctl --endpoints=$ENDPOINTS get name
etcdctl --endpoints=$ENDPOINTS del name

```

#### WRITE ON ONE NODE, READ FROM ANOTHER
```bash
#HTTPS
etcdctl --endpoints=https://192.168.29.61:2379 \
  put age 19


etcdctl --endpoints=https://192.168.29.62:2379 \
  get age
```

#### BRING ETCD-2 DOWN (poweroff)

##### CHECK ENDPOINT STATUS, IT SHOULD ONLY SHOW TWO SERVERS 192.168.29.61 & 192.168.29.63
```bash
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS endpoint health --write-out=table
```

##### STILL DATA IS ACCESSIABLE
```bash
etcdctl --endpoints=$ENDPOINTS get name
```

##### TRY WRITING INTO ETCD, IT WILL BE SUCCEDD
```bash
etcdctl --endpoints=$ENDPOINTS put bike harley-davidson
etcdctl --endpoints=$ENDPOINTS get name
etcdctl --endpoints=$ENDPOINTS get bike
```

##### BRINT ETCD-2 UP AGAIN
```bash
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
```

##### NBRING DOWN ETCD-2 AND ETCD-3 (LOSS OF QUORUM)

##### ACCESS TO ETCD DATA LOST, AS QUORAM LOST

##### CHECK FROM
```bash
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS get bike
```

##### GET ETCD-2 AND ETCD-3 UP AGAIN. CLUSTER WILL BE HEALTHY AGAINN AND NEW LEADER WILL BE SELECTED
```bash
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS get bike
```
