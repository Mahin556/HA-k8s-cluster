### On your local workstation (Linux)

#### Generate TLS certificates
```bash
# Download required binaries
# CA will be a separate machine - ubuntu server
# Install cfssl and cfssljson packages on CA server
{
  sudo apt update
  sudo apt install openssl
  openssl version
}
```

#### Create a Certificate Authority (CA)
```bash
#We then use this CA to create other TLS certificates
{

openssl genrsa -out ca-key.pem 2048

openssl req -x509 -new -nodes \
  -key ca-key.pem \
  -sha256 \
  -days 365 \
  -out ca.pem \
  -subj "/C=IN/ST=Rajasthan/L=India/O=Kubernetes/OU=etcd-ca/CN=etcd"

}

# Files created:
# • ca.pem
# • ca-key.pem
```

#### Create TLS certificate for etcd nodes
```bash
{

export ETCD1_IP=192.168.29.61
export ETCD1_NAME="etcdone"

export ETCD2_IP=192.168.29.62
export ETCD2_NAME="etcdtwo"

export ETCD3_IP=192.168.29.63
export ETCD3_NAME="etcdthree"

#Create OpenSSL config for etcd certs.
#OpenSSL requires SANs via config file (cfssl handled this automatically).
cat > etcdone-openssl.cnf <<EOF
[ req ]
default_bits       = 2048
prompt             = no
default_md         = sha256
req_extensions     = req_ext
distinguished_name = dn

[ dn ]
C  = IN
ST = Rajasthan
L  = India
O  = Kubernetes
OU = etcd
CN = etcdone

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = localhost
DNS.2 = ${ETCD1_NAME}
IP.1  = 127.0.0.1
IP.2  = ${ETCD1_IP}

[ v3_ext ]
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names
EOF


cat > etcdtwo-openssl.cnf <<EOF
[ req ]
default_bits       = 2048
prompt             = no
default_md         = sha256
req_extensions     = req_ext
distinguished_name = dn

[ dn ]
C  = IN
ST = Rajasthan
L  = India
O  = Kubernetes
OU = etcd
CN = etcdtwo

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = localhost
DNS.2 = ${ETCD2_NAME}
IP.1  = 127.0.0.1
IP.2  = ${ETCD2_IP}

[ v3_ext ]
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names
EOF


cat > etcdthree-openssl.cnf <<EOF
[ req ]
default_bits       = 2048
prompt             = no
default_md         = sha256
req_extensions     = req_ext
distinguished_name = dn

[ dn ]
C  = IN
ST = Rajasthan
L  = India
O  = Kubernetes
OU = etcd
CN = etcdthree

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = localhost
DNS.2 = ${ETCD3_NAME}
IP.1  = 127.0.0.1
IP.2  = ${ETCD3_IP}

[ v3_ext ]
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names
EOF

# Generate etcd private key
openssl genrsa -out etcdone-key.pem 2048

openssl genrsa -out etcdtwo-key.pem 2048

openssl genrsa -out etcdthree-key.pem 2048


# Create Certificate Signing Request (CSR)
openssl req -new \
  -key etcdone-key.pem \
  -out etcdone.csr \
  -config etcdone-openssl.cnf

openssl req -new \
  -key etcdtwo-key.pem \
  -out etcdtwo.csr \
  -config etcdtwo-openssl.cnf

openssl req -new \
  -key etcdthree-key.pem \
  -out etcdthree.csr \
  -config etcdthree-openssl.cnf


# Sign etcd certificate using CA
openssl x509 -req \
  -in etcdone.csr \
  -CA ca.pem \
  -CAkey ca-key.pem \
  -CAcreateserial \
  -out etcdone.pem \
  -days 365 \
  -sha256 \
  -extensions v3_ext \
  -extfile etcdone-openssl.cnf

openssl x509 -req \
  -in etcdtwo.csr \
  -CA ca.pem \
  -CAkey ca-key.pem \
  -CAcreateserial \
  -out etcdtwo.pem \
  -days 365 \
  -sha256 \
  -extensions v3_ext \
  -extfile etcdtwo-openssl.cnf

openssl x509 -req \
  -in etcdthree.csr \
  -CA ca.pem \
  -CAkey ca-key.pem \
  -CAcreateserial \
  -out etcdthree.pem \
  -days 365 \
  -sha256 \
  -extensions v3_ext \
  -extfile etcdthree-openssl.cnf


openssl x509 -in etcdone.pem -text -noout
openssl x509 -in etcdtwo.pem -text -noout
openssl x509 -in etcdthree.pem -text -noout

#This will generate these files:
# etcdone-openssl.cnf
# etcdtwo-openssl.cnf
# etcdthree-openssl.cnf
# etcdone-key.pem
# etcdtwo-key.pem
# etcdthree-key.pem
# etcdone.csr
# etcdtwo.csr
# etcdthree.csr
# etcdone.pem
# etcdtwo.pem
# etcdthree.pem
# ca.srl
# ca.pem
# ca-key.pem

}
```

#### Create OpenSSL config for API server client cert
```bash
{

cat > apiserver-etcd-client-openssl.cnf <<EOF
[ req ]
default_bits       = 2048
prompt             = no
default_md         = sha256
distinguished_name = dn
req_extensions     = req_ext

[ dn ]
C  = IN
ST = Rajasthan
L  = Jaipur
O  = Kubernetes
OU = ControlPlane
CN = kube-apiserver-etcd-client

[ req_ext ]
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth
EOF

openssl genrsa -out apiserver-etcd-client-key.pem 2048

openssl req -new \
  -key apiserver-etcd-client-key.pem \
  -out apiserver-etcd-client.csr \
  -config apiserver-etcd-client-openssl.cnf

openssl x509 -req \
  -in apiserver-etcd-client.csr \
  -CA ca.pem \
  -CAkey ca-key.pem \
  -CAcreateserial \
  -out apiserver-etcd-client.pem \
  -days 365 \
  -sha256 \
  -extensions req_ext \
  -extfile apiserver-etcd-client-openssl.cnf

openssl x509 -in apiserver-etcd-client.pem -noout -subject
#CN = kube-apiserver-etcd-client

openssl x509 -in apiserver-etcd-client.pem -noout -text | grep -A2 "Extended Key Usage"
#TLS Web Client Authentication

# File Generated
# apiserver-etcd-client-openssl.cnf
# apiserver-etcd-client-key.pem
# apiserver-etcd-client.csr
# apiserver-etcd-client.pem
# ca.srl

}
```

#### Copy the certificates to etcd nodes
```bash
{
  apt install -y sshpass

  PASSWORD="root"
  NODES=(etcdone etcdtwo etcdthree)

  # Create PKI directory on all nodes
  for node in "${NODES[@]}"; do
    sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@"$node" "
      mkdir -p /etc/etcd/pki &&
      chown -R root:root /etc/etcd/pki &&
      chmod 700 /etc/etcd/pki
    "
  done

  # Copy certificates + set permissions
  for node in "${NODES[@]}"; do
    sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no \
      ca.pem \
      ${node}.pem \
      ${node}-key.pem \
      root@${node}:/etc/etcd/pki/

    sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@"$node" "
      chmod 600 /etc/etcd/pki/${node}-key.pem &&
      chmod 644 /etc/etcd/pki/${node}.pem &&
      chmod 644 /etc/etcd/pki/ca.pem
    "
  done
}
```

#### Copy certs to masterone node
```bash
{

  PASSWORD="root"

  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@masterone "mkdir -p /etc/kubernetes/pki/etcd/"

  sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no ca.pem \
    apiserver-etcd-client.pem \
    apiserver-etcd-client-key.pem \
    root@masterone:/etc/kubernetes/pki/etcd/

  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@masterone "chmod 644 /etc/kubernetes/pki/etcd/ca.pem"
  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@masterone "chmod 644 /etc/kubernetes/pki/etcd/apiserver-etcd-client.pem"
  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no root@masterone "chmod 600 /etc/kubernetes/pki/etcd/apiserver-etcd-client-key.pem"

}
```

### On all etcd nodes
Perform all commands logged in as root user or prefix each command with sudo as appropriate

#### INSTALL ETCD ON EACH NODE
```bash
#Download etcd & etcdctl binaries from Github
{
  ETCD_VER=v3.5.21
  wget -q --show-progress "https://github.com/etcd-io/etcd/releases/download/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz"
  tar -zxf etcd-${ETCD_VER}-linux-amd64.tar.gz
  mv etcd-${ETCD_VER}-linux-amd64/etcd* /usr/local/bin/
  rm -rf etcd*
  which etcdctl
}
```

#### CREATE ETCD SERVICE FILE(etcd-1)
```bash
{


export ETCD1_IP=192.168.29.61
export ETCD1_NAME="etcdone"

export ETCD2_IP=192.168.29.62
export ETCD2_NAME="etcdtwo"

export ETCD3_IP=192.168.29.63
export ETCD3_NAME="etcdthree"

export ETCD_NODE_NAME=$(hostname -s)
echo $ETCD_NODE_NAME

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcdone.pem \\
  --key-file=/etc/etcd/pki/etcdone-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcdone.pem \\
  --peer-key-file=/etc/etcd/pki/etcdone-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD1_NAME}:2380 \\
  --listen-peer-urls https://${ETCD1_IP}:2380 \\
  --listen-client-urls https://${ETCD1_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD1_NAME}:2379 \\
  --initial-cluster-token etcd-cluster \\
  --initial-cluster etcdone=https://${ETCD1_NAME}:2380,etcdtwo=https://${ETCD2_NAME}:2380,etcdthree=https://${ETCD3_NAME}:2380 \\
  --initial-cluster-state new 

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start etcd
systemctl enable etcd

}
```

#### CREATE ETCD SERVICE FILE(etcd-2)
```bash
{


export ETCD1_IP=192.168.29.61
export ETCD1_NAME="etcdone"

export ETCD2_IP=192.168.29.62
export ETCD2_NAME="etcdtwo"

export ETCD3_IP=192.168.29.63
export ETCD3_NAME="etcdthree"

export ETCD_NODE_NAME=$(hostname -s)

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcdtwo.pem \\
  --key-file=/etc/etcd/pki/etcdtwo-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcdtwo.pem \\
  --peer-key-file=/etc/etcd/pki/etcdtwo-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD2_NAME}:2380 \\
  --listen-peer-urls https://${ETCD2_IP}:2380 \\
  --listen-client-urls https://${ETCD2_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD2_NAME}:2379 \\
  --initial-cluster-token etcd-cluster \\
  --initial-cluster etcdone=https://${ETCD1_NAME}:2380,etcdtwo=https://${ETCD2_NAME}:2380,etcdthree=https://${ETCD3_NAME}:2380 \\
  --initial-cluster-state new

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now etcd

}
```

#### CREATE ETCD SERVICE FILE(etcd-3)
```bash
{

export ETCD1_IP=192.168.29.61
export ETCD1_NAME="etcdone"

export ETCD2_IP=192.168.29.62
export ETCD2_NAME="etcdtwo"

export ETCD3_IP=192.168.29.63
export ETCD3_NAME="etcdthree"

export ETCD_NODE_NAME=$(hostname -s)

mkdir -p /var/lib/etcd/
mkdir -p /etc/systemd/system/

sudo cat <<EOF >/etc/systemd/system/etcd.service
[Unit]
Description=etcd
[Service]
Type=exec
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NODE_NAME} --data-dir=/var/lib/etcd \\
  --cert-file=/etc/etcd/pki/etcdthree.pem \\
  --key-file=/etc/etcd/pki/etcdthree-key.pem \\
  --peer-cert-file=/etc/etcd/pki/etcdthree.pem \\
  --peer-key-file=/etc/etcd/pki/etcdthree-key.pem \\
  --trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${ETCD3_NAME}:2380 \\
  --listen-peer-urls https://${ETCD3_IP}:2380 \\
  --listen-client-urls https://${ETCD3_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${ETCD3_NAME}:2379 \\
  --initial-cluster-token etcd-cluster \\
  --initial-cluster etcdone=https://${ETCD1_NAME}:2380,etcdtwo=https://${ETCD2_NAME}:2380,etcdthree=https://${ETCD3_NAME}:2380 \\
  --initial-cluster-state new

Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start etcd
systemctl enable etcd
}

```

#### Better to export these as environment variables and connect to the clutser instead of a specific node
```bash
#On All Nodes
export ENDPOINTS=https://etcdone:2379,https://etcdtwo:2379,https://etcdthree:2379
export ETCDCTL_CACERT=/etc/etcd/pki/ca.pem

#On etcdone
export ETCDCTL_CERT=/etc/etcd/pki/etcdone.pem
export ETCDCTL_KEY=/etc/etcd/pki/etcdone-key.pem
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS endpoint health --write-out=table

#On etcdtwo
export ETCDCTL_CERT=/etc/etcd/pki/etcdtwo.pem
export ETCDCTL_KEY=/etc/etcd/pki/etcdtwo-key.pem
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS endpoint health --write-out=table

#On etcdthree
export ETCDCTL_CERT=/etc/etcd/pki/etcdthree.pem
export ETCDCTL_KEY=/etc/etcd/pki/etcdthree-key.pem
etcdctl --endpoints=$ENDPOINTS endpoint status --write-out=table
etcdctl --endpoints=$ENDPOINTS endpoint health --write-out=table
```


