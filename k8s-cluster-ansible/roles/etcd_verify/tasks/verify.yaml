---
- name: Show etcd cluster status table
  command: >
    etcdctl
    --endpoints={% for host in groups['etcd'] %}https://{{ hostvars[host].ansible_host }}:2379{% if not loop.last %},{% endif %}{% endfor %}
    endpoint status --write-out=table
  environment:
    ETCDCTL_CACERT: "{{ etcd_pki_dir }}/{{ etcd_ca_crt_name }}"
    ETCDCTL_CERT: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.crt"
    ETCDCTL_KEY: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.key"
  changed_when: false
  register: etcd_status
  

- name: Show etcd cluster health table
  command: >
    etcdctl
    --endpoints={% for host in groups['etcd'] %}https://{{ hostvars[host].ansible_host }}:2379{% if not loop.last %},{% endif %}{% endfor %}
    endpoint health --write-out=table
  environment:
    ETCDCTL_CACERT: "{{ etcd_pki_dir }}/{{ etcd_ca_crt_name }}"
    ETCDCTL_CERT: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.crt"
    ETCDCTL_KEY: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.key"
  changed_when: false
  register: etcd_health

- name: Overwrite etcd verification log if overwrite_logs is true
  delegate_to: localhost
  run_once: true
  copy:
    dest: "{{ etcd_verify_output_dir }}/etcd_verify.log"
    content: ""
    mode: '0644'
  when: overwrite_logs

- name: Append etcd verification to controller log
  delegate_to: localhost
  run_once: true
  shell: |
    TS=$(date +%Y-%m-%d_%H-%M-%S)
    {
      echo "===== ETCD VERIFY ${TS} ====="
      echo
      echo "{{ etcd_status.stdout }}"
      echo
      echo "{{ etcd_health.stdout }}"
      echo
    } >> ${LOG_FILE}
  environment:
    LOG_FILE: "{{ etcd_verify_output_dir }}/etcd_verify.log"
  changed_when: false

- name: Fail if etcd cluster unhealthy
  fail:
    msg: "Etcd cluster is unhealthy!"
  when: "'unhealthy' in etcd_health.stdout"

- name: Write a test data to etcd cluster
  command: >
    etcdctl
    --endpoints={% for host in groups['etcd'] %}https://{{ hostvars[host].ansible_host }}:2379{% if not loop.last %},{% endif %}{% endfor %}
    put test_key test_value
  environment:
    ETCDCTL_CACERT: "{{ etcd_pki_dir }}/{{ etcd_ca_crt_name }}"
    ETCDCTL_CERT: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.crt"
    ETCDCTL_KEY: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.key"
  register: etcd_put

- name: Read the test data from etcd cluster
  command: >
    etcdctl
    --endpoints={% for host in groups['etcd'] %}https://{{ hostvars[host].ansible_host }}:2379{% if not loop.last %},{% endif %}{% endfor %}
    get test_key
  environment:
    ETCDCTL_CACERT: "{{ etcd_pki_dir }}/{{ etcd_ca_crt_name }}"
    ETCDCTL_CERT: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.crt"
    ETCDCTL_KEY: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.key"
  register: etcd_get

- name: Delete the test data from etcd cluster
  command: >
    etcdctl
    --endpoints={% for host in groups['etcd'] %}https://{{ hostvars[host].ansible_host }}:2379{% if not loop.last %},{% endif %}{% endfor %}
    del test_key
  environment:
    ETCDCTL_CACERT: "{{ etcd_pki_dir }}/{{ etcd_ca_crt_name }}"
    ETCDCTL_CERT: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.crt"
    ETCDCTL_KEY: "{{ etcd_pki_dir }}/{{ inventory_hostname.split('.')[0] }}.key"
  register: etcd_del

- name: Assert that the test data is correct
  assert:
    that:
      - etcd_put.rc == 0
      - etcd_get.rc == 0
      - etcd_del.rc == 0
      - "'test_value' in etcd_get.stdout"
    fail_msg: "Failed to verify etcd cluster read/write operations!" 