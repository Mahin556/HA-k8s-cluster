### Configuring Load Balancer

#### SSH into the loadbalancer machine 

#### Switch to root using sudo -i

#### Change hostname (recommended)

#### Update repo and system
```bash
sudo apt-get update -y
```

#### Install HAProxy
```bash
sudo apt-get install haproxy -y
```

#### Edit haproxy configuration file
```bash
cat <<EOF >> /etc/haproxy/haproxy.cfg
#add these lines at bottom of file <respect the indents>
frontend kubernetes-api
         bind *:6443
         mode tcp
         option tcplog
         default_backend kube-master-nodes

backend kube-master-nodes
        mode tcp
        balance roundrobin
        option tcp-check
        default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
        server masterone 192.168.29.51:6443 check
        server mastertwo 192.168.29.52:6443 check
        server masterthree 192.168.29.53:6443 check
EOF
```

#### Enable HAProxy Stats
```bash
#Edit the HAProxy configuration file:
cat <<EOF >> /etc/haproxy/haproxy.cfg
#Add the following configuration at the end of the file:
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
EOF

ss -tulnp | grep -i 8404
```

#### Restart haproxy and check
```bash
systemctl restart haproxy
systemctl enable haproxy
systemctl status haproxy

#Check if the port 6443 is open and responding for haproxy connection or not
ss -lntp | grep 6443
nc -v localhost 6443

#Access the HAProxy stats page in a browser:
http://LOAD_BALANCER_IP:8404
```
```bash
root@lbone:~# ss -tulnp | grep -i 8404
tcp   LISTEN 0      4096                           0.0.0.0:8404      0.0.0.0:*    users:(("haproxy",pid=24325,fd=7))
root@lbone:~# ss -lntp | grep 6443
LISTEN 0      4096         0.0.0.0:6443      0.0.0.0:*    users:(("haproxy",pid=24325,fd=6))
root@lbone:~# nc -v localhost 6443
Connection to localhost (127.0.0.1) 6443 port [tcp/*] succeeded!
```

![alt text](image.png)