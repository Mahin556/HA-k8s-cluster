#### Disabling SWAP
```bash
sudo swapoff -a
sed -e '/swap/s/^/#/g' -i /etc/fstab
```

#### Loading Kernel Modules
```bash
tee /etc/modules-load.d/modules.conf <<EOF
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter

tee /etc/sysctl.d/kubernetes.conf <<EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF

sudo sysctl --system
```

#### Set Kubernetes and CRI-O Version
```bash
KUBERNETES_VERSION=v1.35
CRIO_VERSION=v1.35
```

#### Install all required packages
```bash
apt-get update -y
apt-get install -y software-properties-common curl

curl -fsSL https://pkgs.k8s.io/core:/stable:/$KUBERNETES_VERSION/deb/Release.key |
    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/$KUBERNETES_VERSION/deb/ /" |
    tee /etc/apt/sources.list.d/kubernetes.list

curl -fsSL https://download.opensuse.org/repositories/isv:/cri-o:/stable:/$CRIO_VERSION/deb/Release.key |
    gpg --dearmor -o /etc/apt/keyrings/cri-o-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://download.opensuse.org/repositories/isv:/cri-o:/stable:/$CRIO_VERSION/deb/ /" |
    tee /etc/apt/sources.list.d/cri-o.list

sudo apt-get update -y
sudo apt-get install -y cri-o cri-tools kubelet kubeadm kubectl -y

sudo apt-mark hold kubelet kubeadm kubectl
sudo systemctl start crio.service
```

#### Verify installations
```bash
kubeadm version
kubelet --version
kubectl version --client
```

#### Exposing ETCD Node via Environment Variables
```bash
export ETCD1_IP=192.168.29.61
export ETCD2_IP=192.168.29.62
export ETCD3_IP=192.168.29.63
```

#### Creating cluster configuration file `kubeadm-config.yaml`
```bash
cat <<EOF > kubeadm-config.yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration

clusterName: kubernetes
kubernetesVersion: v1.35.0

networking:
  podSubnet: "192.168.0.0/16"
  serviceSubnet: "10.96.0.0/16"

# External ETCD configuration
etcd:
  external:
    endpoints:
      - https://192.168.29.61:2379
      - https://192.168.29.62:2379
      - https://192.168.29.63:2379
    caFile: /etc/kubernetes/pki/etcd/ca.pem
    certFile: /etc/kubernetes/pki/etcd/apiserver-etcd-client.pem
    keyFile: /etc/kubernetes/pki/etcd/apiserver-etcd-client-key.pem
---
apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration

localAPIEndpoint:
  advertiseAddress: "192.168.29.51"
  bindPort: 6443
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration

serializeImagePulls: false
maxParallelImagePulls: 10

evictionHard:
  memory.available: "200Mi"
  nodefs.available: "20%"
  nodefs.inodesFree: "5%"
EOF
```

#### Pulling configuration images and Starting Cluster using kubeadm init
```bash
sudo kubeadm config images pull
sleep 5
kubeadm init --config kubeadm-config.yaml --upload-certs --ignore-preflight-errors=all
sleep 20
```
In case of reset the control plane
```bash
kubeadm reset -f
rm -rf /etc/kubernetes /var/lib/etcd
systemctl restart crio
systemctl restart kubelet
```


#### Setting up home directory and copy `/etc/kubernetes/admin.conf` into `~/.kube/config`
```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

#### Installing Calico as CNI
```bash
kubectl apply -f https://docs.tigera.io/calico/latest/manifests/calico.yaml
```

#### Generate a Joining command
```bash
kubeadm token create --print-join-command #For worker nodes
```

#### Join token for worker nodes
```bash
kubeadm join <load-balancer-private-ip>:6443 --token <token> \
--discovery-token-ca-cert-hash sha256:<hash>
```

#### Check control plane node status:
```bash
kubectl get nodes
kubectl get nodes -o wide
kubectl get pods --all-namespaces
```

#### Check from ETCD nodes
```bash
unset ETCDCTL_ENDPOINTS
unset ETCDCTL_CACERT
unset ETCDCTL_CERT
unset ETCDCTL_KEY

export ETCDCTL_CACERT=/etc/etcd/pki/ca.pem
export ETCDCTL_CERT=/etc/etcd/pki/etcd.pem
export ETCDCTL_KEY=/etc/etcd/pki/etcd-key.pem

etcdctl get / --prefix --keys-only
```