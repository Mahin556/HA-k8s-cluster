# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|

  # -----------------------------
  # Base box
  # -----------------------------
  config.vm.box = "bento/ubuntu-22.04"

  # -----------------------------
  # SSH stability
  # -----------------------------
  config.vm.boot_timeout = 600
  config.ssh.forward_agent = true
  config.ssh.keep_alive = true
  config.ssh.insert_key = true

  config.vm.provision "file", source: "files/ansible.pub", destination: "/tmp/ansible.pub"
  config.vm.provision "file", source: "/root/.ssh/ansible", destination: "/tmp/ansible"
  config.vm.provision "file", source: "files/hosts", destination: "/tmp/hosts"
  config.vm.provision "shell", path: "bootstrap.sh"

  # -----------------------------
  # Number â†’ word mapping
  # -----------------------------
  NUM_WORDS = {
    1 => "one",
    2 => "two",
    3 => "three",
    4 => "four",
    5 => "five"
  }

  # =============================
  # CONTROL PLANE (MASTERS)
  # =============================
  Master_Node_Count = 3

  (1..Master_Node_Count).each do |i|
    name = NUM_WORDS[i]

    config.vm.define "master#{name}" do |node|
      node.vm.hostname = "master#{name}.example.com"

      node.vm.network "public_network",
        ip: "192.168.29.5#{i}",
        netmask: "255.255.255.0",
        gateway: "192.168.29.1"

      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-master#{name}"
        vb.memory = 2048
        vb.cpus = 2
      end
    end
  end

  # =============================
  # ETCD CLUSTER
  # =============================
  Etcd_Node_Count = 3

  (1..Etcd_Node_Count).each do |i|
    name = NUM_WORDS[i]

    config.vm.define "etcd#{name}" do |node|
      node.vm.hostname = "etcd#{name}.example.com"

      node.vm.network "public_network",
        ip: "192.168.29.6#{i}",
        netmask: "255.255.255.0",
        gateway: "192.168.29.1"

      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-etcd#{name}"
        vb.memory = 1024
        vb.cpus = 1
      end
    end
  end

  # =============================
  # WORKER NODES
  # =============================
  Worker_Node_Count = 1

  (1..Worker_Node_Count).each do |i|
    name = NUM_WORDS[i]

    config.vm.define "worker#{name}" do |node|
      node.vm.hostname = "worker#{name}.example.com"

      node.vm.network "public_network",
        ip: "192.168.29.7#{i}",
        netmask: "255.255.255.0",
        gateway: "192.168.29.1"

      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-worker#{name}"
        vb.memory = 1024
        vb.cpus = 1
      end
    end
  end

    # =============================
  # LOAD BALANCER
  # =============================
  LoadBalancer_Count = 2

  (1..LoadBalancer_Count).each do |i|
    name = NUM_WORDS[i]

    config.vm.define "lb#{name}" do |node|
      node.vm.hostname = "lb#{name}.example.com"

      node.vm.network "public_network",
        ip: "192.168.29.8#{i}",
        netmask: "255.255.255.0",
        gateway: "192.168.29.1"

      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-lb#{name}"
        vb.memory = 1024
        vb.cpus = 1
      end
    end
  end
end
