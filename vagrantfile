# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "cloud-image/ubuntu-24.04"
  config.vm.box_version = "20260108.0.0"

  # =========================
  # Common OS setup (ALL nodes)
  # =========================
  config.vm.provision "shell", inline: <<-SHELL
    set -e

    swapoff -a
    sed -i '/ swap / s/^/#/' /etc/fstab

    modprobe overlay
    modprobe br_netfilter

    cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
    sysctl --system
  SHELL

  # ==========
  # ETCD NODES
  # ==========
  (1..3).each do |i|
    config.vm.define "etcd-#{i}" do |node|
      node.vm.hostname = "etcd-#{i}"
      node.vm.network "private_network", ip: "192.168.56.2#{i}"

      node.vm.provider "virtualbox" do |vb|
        vb.memory = 1024
        vb.cpus = 1
      end
    end
  end

  # =================
  # CONTROL PLANE NODES
  # =================
  (1..3).each do |i|
    config.vm.define "master-#{i}" do |node|
      node.vm.hostname = "master-#{i}"
      node.vm.network "private_network", ip: "192.168.56.1#{i}"

      node.vm.provider "virtualbox" do |vb|
        vb.memory = 2048
        vb.cpus = 2
      end
    end
  end

  # ========
  # WORKER
  # ========
  config.vm.define "worker-1" do |node|
    node.vm.hostname = "worker-1"
    node.vm.network "private_network", ip: "192.168.56.31"

    node.vm.provider "virtualbox" do |vb|
      vb.memory = 1024
      vb.cpus = 1
    end
  end
end
