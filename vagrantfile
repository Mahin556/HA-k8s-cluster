# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # -----------------------------
  # Base box (fast & stable)
  # -----------------------------
  config.vm.box = "bento/ubuntu-22.04"
  # 22.04 is MORE stable than 24.04 for VirtualBox right now

  # -----------------------------
  # SSH stability (CRITICAL)
  # -----------------------------
  config.vm.boot_timeout = 600
  config.ssh.forward_agent = false
  config.ssh.keep_alive = true
  config.ssh.insert_key = true

  # -----------------------------
  # Common OS setup (ALL nodes)
  # -----------------------------
  config.vm.provision "shell", privileged: true, inline: <<-SHELL
    set -e
    
    # Disable swap (Kubernetes requirement)
    swapoff -a
    sed -i '/ swap / s/^/#/' /etc/fstab

    # Kernel modules
    modprobe overlay
    modprobe br_netfilter

    # Sysctl params
    cat <<EOF >/etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
    sysctl --system
  SHELL


  # ==================
  # CONTROL PLANE
  # ==================
  (1..3).each do |i|
    config.vm.define "master-#{i}" do |node|
      node.vm.hostname = "master-#{i}"
      node.vm.network "public_network", ip: "192.168.29.5#{i}", netmask: "255.255.255.0", gateway: "192.168.29.1"
      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-master-#{i}"
        vb.memory = 2048
        vb.cpus = 2
      end
    end
  end

  # ==================
  # ETCD NODES
  # ==================
  (1..3).each do |i|
    config.vm.define "etcd-#{i}" do |node|
      node.vm.hostname = "etcd-#{i}"
      node.vm.network "public_network", ip: "192.168.29.6#{i}", netmask: "255.255.255.0", gateway: "192.168.29.1"
      node.vm.provider "virtualbox" do |vb|
        vb.name = "k8s-etcd-#{i}"
        vb.memory = 1024
        vb.cpus = 1
      end
    end
  end

  # ==================
  # WORKER
  # ==================
  config.vm.define "worker-1" do |node|
    node.vm.hostname = "worker-1"
    node.vm.network "public_network", ip: "192.168.29.71"
    node.vm.provider "virtualbox" do |vb|
      vb.name = "k8s-worker-1"
      vb.memory = 1024
      vb.cpus = 1
    end
  end
end
